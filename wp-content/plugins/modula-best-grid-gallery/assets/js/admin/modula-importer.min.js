!function(e){"use strict";var t={counts:0,completed:0,ajaxRequests:[],ajaxStarted:1,ajaxTimeout:null,source:"",modulaGalleryIds:{},attachments:[],importChunk:5,init:function(){e('.modula-importer-wrapper input[type="submit"]').click((function(a){a.preventDefault(),t.source=e(this).parents(".modula-importer-wrapper").attr("source"),t.completed=0,t.attachments=[];var o=e("#modula_importer_"+t.source+" input[name=gallery]:checked");if(0==o.length)return alert(modula_importer.empty_gallery_selection),!1;e("#modula_importer_"+t.source+" :input").prop("disabled",!0);var r=[];e(o).each((function(a){"wp_core"==t.source?r[a]=e(this).attr("data-id"):r[a]=e(this).val()})),t.processAjax(r)}))},processAjax:function(a){var o="keep";e("#delete-old-entries").prop("checked")&&(o="delete"),a.forEach((function(a){var r=e("#modula_importer_"+t.source+" label[data-id="+a+"]"),s=a,n=e('input[data-id="'+a+'"]').data("image-count"),l={},i=!1,c=0;if(e(r).removeClass().addClass("importing"),e("span",e(r)).not(".importing-status").html(modula_importer.importing),"wp_core"==t.source&&(i=e("input#wp_core-galleries-"+s).next("a").text()),"wp_core"==t.source&&(s=JSON.parse(e("#modula_importer_wp_core input[data-id="+a+"]").val())),r.data("imported")){t.counts+=1;var d={url:modula_importer.ajax,type:"post",async:!0,cache:!1,dataType:"json",data:{action:"modula_importer_"+t.source+"_gallery_import",id:s,nonce:modula_importer.nonce,clean:o,source:t.source,imported:!0},success:function(e){if(t.ajaxStarted=t.ajaxStarted-1,!e.success)return r.find("span").not(".importing-status").text(e.message),t.completed=t.completed+1,void(t.counts==t.completed&&"wp_core"!=t.source&&t.updateImported(!1,o));t.modulaGalleryIds[s]=e.modula_gallery_id,r.find("span").not(".importing-status").html(e.message),t.completed=t.completed+1,t.counts==t.completed&&"wp_core"!=t.source&&t.updateImported(t.modulaGalleryIds,o)}};t.ajaxRequests.push(d),t.attachments=[]}else for(t.counts+=Math.floor(n/t.importChunk)+1,c=0;c<=n;c+=t.importChunk)l={url:modula_importer.ajax,type:"post",async:!0,cache:!1,dataType:"json",data:{action:"modula_ajax_import_images",id:s,nonce:modula_importer.nonce,chunk:c,source:t.source},success:function(a){if(t.ajaxStarted=t.ajaxStarted-1,a&&void 0!==a.attachments&&e.merge(t.attachments,a.attachments),e("span.importing-status",e(r)).length&&e("span.importing-status",e(r)).html("Imported:"+t.attachments.length+" / "+n),t.completed=t.completed+1,"end_of_array"==a.end_of_array){var l={url:modula_importer.ajax,type:"post",async:!0,cache:!1,dataType:"json",data:{action:"modula_importer_"+t.source+"_gallery_import",id:s,nonce:modula_importer.nonce,clean:o,gallery_title:i,attachments:t.attachments,source:t.source},success:function(e){if(!e.success)return r.find("span").not(".importing-status").text(e.message),void(t.counts==t.completed&&"wp_core"!=t.source&&t.updateImported(!1,o));t.modulaGalleryIds[s]=e.modula_gallery_id,r.find("span").not(".importing-status").html(e.message),t.counts==t.completed&&"wp_core"!=t.source&&t.updateImported(t.modulaGalleryIds,o)}};e.ajax(l),t.attachments=[]}}},t.ajaxRequests.push(l),l={}})),t.runAjaxs()},runAjaxs:function(){for(var a;t.ajaxStarted<2&&t.ajaxRequests.length>0;)t.ajaxStarted=t.ajaxStarted+1,a=t.ajaxRequests.shift(),e.ajax(a);t.ajaxRequests.length>0?t.ajaxTimeout=setTimeout((function(){console.log("Delayed 1s"),t.runAjaxs()}),1e3):e("#modula_importer_"+t.source+" :input").prop("disabled",!1)},updateImported:function(a,o){var r={action:"modula_importer_"+t.source+"_gallery_imported_update",galleries:a,clean:o,nonce:modula_importer.nonce};e.post(ajaxurl,r,(function(e){window.location.href=e}))}};e(document).ready((function(){e("#modula_select_gallery_source").on("change",(function(){var t=e(this).val();e("body").find(".update-complete").length&&e("body").find(".update-complete").hide();var a={action:"modula_importer_get_galleries",nonce:modula_importer.nonce,source:t};e.post(ajaxurl,a,(function(a){a&&(e("#modula-"+t+"-importer").removeClass("hide"),e("#modula-"+t+"-importer").find(".modula-found-galleries").html(a),e(".modula-importer-row").not(e("#modula-"+t+"-importer")).addClass("hide"),"none"!=t&&e("#modula-"+t+"-importer").find('input[type="checkbox"]').not("#select-all-"+t).length>0?e(".select-all-wrapper").removeClass("hide"):(e("#modula-"+t+"-importer .modula-importer-upsell-wrapper").addClass("hide"),e("#modula-"+t+"-importer .select-all-checkbox,#modula-"+t+"-importer .select-all-checkbox-wrapper").addClass("hide"),e("#modula-"+t+"-importer").find('input[type="submit"]').addClass("hide"),e(".select-all-wrapper").addClass("hide")))}))})),e("body").on("click",".modula-all-selection",(function(t){t.preventDefault();var a=e(this).parents("td").find('input[type="checkbox"]');"#select_all"==e(this).attr("href")?a.each((function(){e(this).is(":visible")&&a.prop("checked",!0)})):a.each((function(){e(this).is(":visible")&&a.prop("checked",!1)}))})),t.init()}))}(jQuery);